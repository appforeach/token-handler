@Poc.Yarp_HostAddress = http://localhost:5198
@Poc.KeyCloak_HostAddress = http://localhost:8080
@Poc.KeyCloak_TokenEndpoint = http://localhost:8080/realms/poc/protocol/openid-connect/token


### Get Client Credentials Grant Type from KeyCloak
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded
  
grant_type=client_credentials&client_id=bff&client_secret=your-client-secret-here

###

### Login to KeyCloak with Password Grant Type as an admin user
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=bff&client_secret=your-client-secret-here&username=admin@example.com&password=admin123

###

### Login to KeyCloak with Password Grant Type a regular user
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=bff&client_secret=your-client-secret-here&username=test@example.com&password=test123

###

### Login Via Yarp

GET {{Poc.Yarp_HostAddress}}/tokenhandler/login/pkce
Accept: application/json

###

### Call Weather Forecast API via Yarp

@accessToken = eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJoYkQxa25RajgxTWNDV2JlMmtfWTEzQVRVVEp4R0hyLUdfakRhZVJQT1JRIn0.eyJleHAiOjE3NzAzNzg3MzgsImlhdCI6MTc3MDM3ODEzOCwianRpIjoib25ydHJvOjRiYjdiNzYwLTg3NjctYTY0ZS03MTM3LTdmNjU0MzBlYWNkMSIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9yZWFsbXMvcG9jIiwiYXVkIjpbImJmZiIsImFwaSJdLCJzdWIiOiI3MjExNjEyMy05NGQyLTQ3YjEtYjk3NS0yYTNjMmMwYzgyNjAiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJiZmYiLCJzaWQiOiJ6dW94SzkxTmt0OHdUQ1lqXzBGczJPbWciLCJzY29wZSI6IiJ9.By4mzbbiqOXN60uLfcUncjjy7rOHdDL5qetgjMtFhsmifruBRAr6A3M89WPY9y16DQDvq-wBXSg039fUkbBNz0VohNQquJnvkawflBHWOVizDprO9nZyc25yktKkvUGbpvBgA0qGslgcd9zXn9TftIUIDXIR4YdPGdBt5df-nfpkFHJK9hU-xymvxJbKTx5nC0GmgQX0sbLPKrv8JWws8V-RAG89w0z79ByiBYaSRrOibcGfD7oQEwvJfaMOZBaLOy27XNioBA77RvBMgTYGmr44uCYP6zqPtDBMolJyl5fMZFtMGlDppDiH5kAY_BhfEJpv1kPjPVwoXYTRPBhu2Q
GET {{Poc.Yarp_HostAddress}}/weatherforecast
Accept: application/json
Authorization: Bearer {{accessToken}}

###

#####################################################################################################################################################
# TOKEN EXCHANGE TESTS (RFC 8693)
# https://www.rfc-editor.org/rfc/rfc8693.html
#
# IMPORTANT: Token exchange inherits scopes from the subject_token. 
# You cannot add NEW scopes during exchange - only use scopes present in the original token.
# If the subject_token has no scopes, the exchanged token will also have no scopes.
#####################################################################################################################################################

### Step 1: Get a fresh admin token
# NOTE: The 'api' client should have 'profile' and 'email' in its default client scopes       
# to ensure the token includes user claims. Add scope parameter to ensure this.
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=bff&client_secret=your-client-secret-here&username=admin&password=admin123

###

# Copy the access_token from Step 1 response and paste it below
@adminAccessToken = eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJoYkQxa25RajgxTWNDV2JlMmtfWTEzQVRVVEp4R0hyLUdfakRhZVJQT1JRIn0.eyJleHAiOjE3NzAzNzg3MzgsImlhdCI6MTc3MDM3ODEzOCwianRpIjoib25ydHJvOjRiYjdiNzYwLTg3NjctYTY0ZS03MTM3LTdmNjU0MzBlYWNkMSIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9yZWFsbXMvcG9jIiwiYXVkIjpbImJmZiIsImFwaSJdLCJzdWIiOiI3MjExNjEyMy05NGQyLTQ3YjEtYjk3NS0yYTNjMmMwYzgyNjAiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJiZmYiLCJzaWQiOiJ6dW94SzkxTmt0OHdUQ1lqXzBGczJPbWciLCJzY29wZSI6IiJ9.By4mzbbiqOXN60uLfcUncjjy7rOHdDL5qetgjMtFhsmifruBRAr6A3M89WPY9y16DQDvq-wBXSg039fUkbBNz0VohNQquJnvkawflBHWOVizDprO9nZyc25yktKkvUGbpvBgA0qGslgcd9zXn9TftIUIDXIR4YdPGdBt5df-nfpkFHJK9hU-xymvxJbKTx5nC0GmgQX0sbLPKrv8JWws8V-RAG89w0z79ByiBYaSRrOibcGfD7oQEwvJfaMOZBaLOy27XNioBA77RvBMgTYGmr44uCYP6zqPtDBMolJyl5fMZFtMGlDppDiH5kAY_BhfEJpv1kPjPVwoXYTRPBhu2Q

### Step 2: Token Exchange - Basic (Same subject, no audience)
# Scopes are inherited from adminAccessToken - do not add scope parameter
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=bff&client_secret=your-client-secret-here&subject_token={{adminAccessToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token

###

### Step 3: Token Exchange with Audience (for specific microservice)
# Scopes are inherited from adminAccessToken
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=bff&client_secret=your-client-secret-here&subject_token={{adminAccessToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&audience=api

###

### Step 3.1: Token Exchange with Audience (for specific microservice)
# Scopes are inherited from adminAccessToken
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=api&client_secret=your-client-secret-here&subject_token={{adminAccessToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&audience=api

###

### Step 4: Token Exchange - Impersonation (Admin impersonates test user)
# Scopes will be based on the target user's (test) permissions
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=bff&client_secret=your-client-secret-here&subject_token={{adminAccessToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&requested_subject=test

###

### Step 4.1: Token Exchange - Impersonation (User impersonates admin)
# This may fail if 'test' user doesn't have impersonation permissions
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=poc-api&client_secret=your-client-secret-here&subject_token={{adminAccessToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&requested_subject=admin

###

### Step 5: Token Exchange - Impersonation with Audience
# Combines impersonation with audience targeting
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=bff&client_secret=your-client-secret-here&subject_token={{adminAccessToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&requested_subject=test&audience=bff

###

#####################################################################################################################################################
# SERVICE ACCOUNT TOKEN EXCHANGE
#####################################################################################################################################################

### Step 6: Get Service Account Token (Client Credentials)
# Service account tokens typically have limited scopes
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&client_id=poc-api&client_secret=your-client-secret-here

###

# Copy the access_token from Step 6 response and paste it below
@serviceToken = eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJDYjlFUkdnRTV3bVZOR3FJeG9YVkpyRmxrN201bHNNb01WcENtVEUwRFhrIn0.eyJleHAiOjE3NzAxNDY0NDksImlhdCI6MTc3MDE0NjE0OSwianRpIjoidHJydGNjOjA5NjA3YTZkLWFlODAtYTliZC1jNjJiLThjNjA0OGUxYWZkZiIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9yZWFsbXMvcG9jIiwiYXVkIjpbInBvYy1hcGkiLCJyZWFsbS1tYW5hZ2VtZW50Il0sInN1YiI6IjRmZDg5ZGNjLTY3NjYtNDBkNy05NWVhLWMxNDljOGUxZWJkMCIsInR5cCI6IkJlYXJlciIsImF6cCI6InBvYy1hcGkiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbImh0dHA6Ly9sb2NhbGhvc3Q6NTE5OCIsImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCJdLCJyZXNvdXJjZV9hY2Nlc3MiOnsicmVhbG0tbWFuYWdlbWVudCI6eyJyb2xlcyI6WyJpbXBlcnNvbmF0aW9uIiwibWFuYWdlLXVzZXJzIiwidmlldy11c2VycyIsInF1ZXJ5LWdyb3VwcyIsInF1ZXJ5LXVzZXJzIl19fSwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImNsaWVudEhvc3QiOiIxNzIuMjEuMC4xIiwicHJlZmVycmVkX3VzZXJuYW1lIjoic2VydmljZS1hY2NvdW50LXBvYy1hcGkiLCJjbGllbnRBZGRyZXNzIjoiMTcyLjIxLjAuMSIsImNsaWVudF9pZCI6InBvYy1hcGkifQ.UQAxdJGRF-8sTd2tP536ipuK_RYgLWDiv6OiwwMGe0IwMu4ak_BVEnwfvSsnQB-MeK97MKR_1gsVHyz31Q4_qL2q0lBK5UBMfQsNzM3fcMvcLxTFT4HWtvoAK3oryoJ9DOeFOSmYXol51Z3XSPacqblY8SEg6urci1mFIFXGpVVQVHjcd1nEtZLRnzeqBn_mNlIQIX5_mA0tWNhr_YwOuI0yeCz_YsD76ybqfXjTHjCMU4wHthBXwGlVuZSL3DNfHsv-G-5ho7KoPBsTdemb3JwY9efz0fq9OfKNkh8ngCkeoAcyIyqPtgzcBBbhtKYHXPBrQTv0wUGflJSeuE1-Bw

### Step 7: Service-to-User Impersonation (Service acts on behalf of user)
# Service account impersonates a user - scopes based on target user
POST {{Poc.KeyCloak_TokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:token-exchange&client_id=poc-api&client_secret=your-client-secret-here&subject_token={{serviceToken}}&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&requested_subject=test&audience=poc-api

###